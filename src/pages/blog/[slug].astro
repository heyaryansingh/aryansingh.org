---
/**
 * Dynamic Blog Post Page
 *
 * Renders individual blog posts from MDX content collections.
 * Supports images, videos, drawings, and rich formatting.
 */

import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { formatDate } from "../../lib/utils";

export async function getStaticPaths() {
    const posts = await getCollection("blog", ({ data }) => !data.draft);

    return posts.map((post) => ({
        params: { slug: post.slug },
        props: { post },
    }));
}

type Props = {
    post: CollectionEntry<"blog">;
};

const { post } = Astro.props;
const { Content } = await post.render();

// Calculate reading time (rough estimate: 200 words per minute)
const wordCount = post.body?.split(/\s+/).length || 0;
const readingTime = Math.ceil(wordCount / 200);

const typeColors: Record<string, string> = {
    technical: "var(--color-accent-secondary)",
    "paper-summary": "var(--color-accent-primary)",
    "monthly-update": "var(--color-success)",
    reflection: "var(--color-accent-tertiary)",
};
---

<BaseLayout
    title={post.data.title}
    description={post.data.description}
    image={post.data.coverImage}
>
    <article class="blog-post">
        <header class="blog-post__header">
            <div class="container container--narrow">
                <div class="blog-post__meta">
                    <time datetime={post.data.date.toISOString()}>
                        {formatDate(post.data.date)}
                    </time>
                    <span class="blog-post__divider">·</span>
                    <span>{readingTime} min read</span>
                </div>

                <h1 class="blog-post__title">{post.data.title}</h1>

                <p class="blog-post__description">{post.data.description}</p>

                <div class="blog-post__tags">
                    <span
                        class="blog-post__type"
                        style={`--type-color: ${typeColors[post.data.type] || "var(--color-text-tertiary)"}`}
                    >
                        {post.data.type.replace("-", " ")}
                    </span>
                    {
                        post.data.tags.map((tag: string) => (
                            <a
                                href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, "-")}`}
                                class="blog-post__tag"
                            >
                                {tag}
                            </a>
                        ))
                    }
                </div>
            </div>
        </header>

        {
            post.data.coverImage && (
                <div class="blog-post__cover">
                    <img src={post.data.coverImage} alt={post.data.title} />
                </div>
            )
        }

        <div class="blog-post__content container container--narrow">
            <div class="prose">
                <Content />
            </div>
        </div>

        <footer class="blog-post__footer container container--narrow">
            <a href="/blog" class="back-link"> ← Back to all posts </a>
        </footer>
    </article>
</BaseLayout>

<style>
    .blog-post {
        padding-bottom: var(--space-4xl);
    }

    .blog-post__header {
        padding: var(--space-4xl) 0 var(--space-2xl);
        text-align: center;
    }

    .blog-post__meta {
        display: flex;
        justify-content: center;
        gap: var(--space-sm);
        font-size: var(--text-sm);
        color: var(--color-text-tertiary);
        margin-bottom: var(--space-lg);
    }

    .blog-post__divider {
        opacity: 0.5;
    }

    .blog-post__title {
        font-size: var(--text-5xl);
        font-family: var(--font-serif);
        line-height: 1.2;
        margin-bottom: var(--space-lg);
    }

    .blog-post__description {
        font-size: var(--text-xl);
        color: var(--color-text-secondary);
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto var(--space-xl);
    }

    .blog-post__tags {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: var(--space-sm);
    }

    .blog-post__type {
        padding: var(--space-xs) var(--space-md);
        font-size: var(--text-xs);
        font-weight: 500;
        text-transform: capitalize;
        color: var(--type-color);
        border: 1px solid var(--type-color);
        border-radius: var(--radius-md);
    }

    .blog-post__tag {
        padding: var(--space-xs) var(--space-md);
        font-size: var(--text-xs);
        background: var(--color-bg-tertiary);
        border-radius: var(--radius-md);
        color: var(--color-text-secondary);
        text-decoration: none;
        transition: all var(--transition-fast);
    }

    .blog-post__tag:hover {
        background: var(--color-accent-primary);
        color: white;
    }

    .blog-post__cover {
        max-width: 1000px;
        margin: 0 auto var(--space-3xl);
        padding: 0 var(--space-lg);
    }

    .blog-post__cover img {
        width: 100%;
        border-radius: var(--radius-lg);
    }

    .blog-post__content {
        padding: 0 var(--space-lg);
    }

    .blog-post__footer {
        margin-top: var(--space-3xl);
        padding-top: var(--space-xl);
        border-top: 1px solid var(--color-border);
    }

    .back-link {
        color: var(--color-accent-primary);
        text-decoration: none;
        font-weight: 500;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    /* Prose styles for MDX content */
    .prose {
        max-width: 65ch;
        margin: 0 auto;
        line-height: 1.8;
        color: var(--color-text-secondary);
    }

    .prose :global(h2) {
        font-size: var(--text-3xl);
        font-family: var(--font-serif);
        color: var(--color-text-primary);
        margin-top: var(--space-3xl);
        margin-bottom: var(--space-lg);
    }

    .prose :global(h3) {
        font-size: var(--text-2xl);
        font-family: var(--font-serif);
        color: var(--color-text-primary);
        margin-top: var(--space-2xl);
        margin-bottom: var(--space-md);
    }

    .prose :global(p) {
        margin-bottom: var(--space-lg);
    }

    .prose :global(a) {
        color: var(--color-accent-primary);
    }

    .prose :global(img) {
        max-width: 100%;
        border-radius: var(--radius-lg);
        margin: var(--space-xl) 0;
    }

    .prose :global(pre) {
        background: var(--color-bg-tertiary);
        padding: var(--space-lg);
        border-radius: var(--radius-lg);
        overflow-x: auto;
        margin: var(--space-xl) 0;
    }

    .prose :global(code) {
        font-family: var(--font-mono);
        font-size: 0.9em;
    }

    .prose :global(blockquote) {
        border-left: 3px solid var(--color-accent-primary);
        padding-left: var(--space-lg);
        font-style: italic;
        color: var(--color-text-tertiary);
        margin: var(--space-xl) 0;
    }

    .prose :global(ul),
    .prose :global(ol) {
        margin-bottom: var(--space-lg);
        padding-left: var(--space-xl);
    }

    .prose :global(li) {
        margin-bottom: var(--space-sm);
    }
</style>
