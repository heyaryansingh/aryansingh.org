---
/**
 * Custom Cursor Component
 *
 * A custom cursor that follows the mouse with smooth animations.
 * Scales up when hovering over interactive elements.
 *
 * USAGE:
 * Include once in layout: <CustomCursor />
 */
---

<div class="custom-cursor" id="custom-cursor">
  <div class="cursor-dot"></div>
  <div class="cursor-ring"></div>
</div>

<style>
  .custom-cursor {
    pointer-events: none;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9999;
    mix-blend-mode: difference;
  }

  .cursor-dot {
    position: absolute;
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: transform 0.1s ease;
  }

  .cursor-ring {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.3s ease, height 0.3s ease, border-color 0.3s ease;
  }

  .custom-cursor.hover .cursor-dot {
    transform: translate(-50%, -50%) scale(1.5);
  }

  .custom-cursor.hover .cursor-ring {
    width: 60px;
    height: 60px;
    border-color: var(--color-accent-primary);
  }

  .custom-cursor.clicking .cursor-dot {
    transform: translate(-50%, -50%) scale(0.5);
  }

  .custom-cursor.clicking .cursor-ring {
    width: 30px;
    height: 30px;
  }

  /* Hide on touch devices */
  @media (hover: none) and (pointer: coarse) {
    .custom-cursor {
      display: none;
    }
  }

  /* Hide default cursor when custom cursor is active */
  :global(body.custom-cursor-active) {
    cursor: none !important;
  }

  :global(body.custom-cursor-active *) {
    cursor: none !important;
  }
</style>

<script>
  class CustomCursor {
    private cursor: HTMLElement;
    private dot: HTMLElement;
    private ring: HTMLElement;
    private mouseX: number = 0;
    private mouseY: number = 0;
    private dotX: number = 0;
    private dotY: number = 0;
    private ringX: number = 0;
    private ringY: number = 0;
    private animationId: number = 0;
    private isVisible: boolean = false;

    constructor() {
      this.cursor = document.getElementById('custom-cursor')!;
      this.dot = this.cursor.querySelector('.cursor-dot')!;
      this.ring = this.cursor.querySelector('.cursor-ring')!;

      // Check if device supports hover
      if (window.matchMedia('(hover: hover) and (pointer: fine)').matches) {
        this.init();
      }
    }

    private init(): void {
      document.body.classList.add('custom-cursor-active');

      window.addEventListener('mousemove', this.onMouseMove.bind(this));
      window.addEventListener('mousedown', this.onMouseDown.bind(this));
      window.addEventListener('mouseup', this.onMouseUp.bind(this));
      window.addEventListener('mouseenter', this.onMouseEnter.bind(this));
      window.addEventListener('mouseleave', this.onMouseLeave.bind(this));

      // Add hover detection to interactive elements
      this.addHoverListeners();

      // Start animation loop
      this.animate();
    }

    private onMouseMove(e: MouseEvent): void {
      this.mouseX = e.clientX;
      this.mouseY = e.clientY;

      if (!this.isVisible) {
        this.isVisible = true;
        this.cursor.style.opacity = '1';
        this.dotX = this.mouseX;
        this.dotY = this.mouseY;
        this.ringX = this.mouseX;
        this.ringY = this.mouseY;
      }
    }

    private onMouseDown(): void {
      this.cursor.classList.add('clicking');
    }

    private onMouseUp(): void {
      this.cursor.classList.remove('clicking');
    }

    private onMouseEnter(): void {
      this.cursor.style.opacity = '1';
    }

    private onMouseLeave(): void {
      this.cursor.style.opacity = '0';
      this.isVisible = false;
    }

    private addHoverListeners(): void {
      const interactiveElements = document.querySelectorAll(
        'a, button, input, textarea, select, [role="button"], [data-cursor="hover"]'
      );

      interactiveElements.forEach((el) => {
        el.addEventListener('mouseenter', () => {
          this.cursor.classList.add('hover');
        });
        el.addEventListener('mouseleave', () => {
          this.cursor.classList.remove('hover');
        });
      });
    }

    private animate(): void {
      // Smooth follow for dot (faster)
      this.dotX += (this.mouseX - this.dotX) * 0.2;
      this.dotY += (this.mouseY - this.dotY) * 0.2;

      // Smooth follow for ring (slower, creates trailing effect)
      this.ringX += (this.mouseX - this.ringX) * 0.1;
      this.ringY += (this.mouseY - this.ringY) * 0.1;

      this.dot.style.left = `${this.dotX}px`;
      this.dot.style.top = `${this.dotY}px`;
      this.ring.style.left = `${this.ringX}px`;
      this.ring.style.top = `${this.ringY}px`;

      this.animationId = requestAnimationFrame(this.animate.bind(this));
    }

    public destroy(): void {
      cancelAnimationFrame(this.animationId);
      document.body.classList.remove('custom-cursor-active');
    }
  }

  // Initialize
  let cursor: CustomCursor | null = null;

  document.addEventListener('DOMContentLoaded', () => {
    cursor = new CustomCursor();
  });

  document.addEventListener('astro:before-swap', () => {
    cursor?.destroy();
  });

  document.addEventListener('astro:after-swap', () => {
    cursor = new CustomCursor();
  });
</script>
